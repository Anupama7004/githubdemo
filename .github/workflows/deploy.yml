deploy:
  needs: build
  runs-on: [self-hosted, windows]
  steps:
    - name: Checkout code
    uses: actions/checkout@v4

    - name: Download artifact (corporate SSL safe)
      uses: actions/download-artifact@v4
      env:
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
      with:
        name: build-output
        path: release

    - name: Verify release files (inline PowerShell, no .ps1 execution)
      shell: pwsh
      run: |
        Write-Host "Listing release directory..."
        if (Test-Path "release") {
            Get-ChildItem -Recurse -Force release
        } else {
            Write-Error "Release folder missing!"
        }

    - name: Run deployment script (INLINE, no ps1 file)
      shell: pwsh
      run: |
        Write-Host "=== Deployment Started ==="
        
        if (!(Test-Path "release")) {
            Write-Error "Release folder missing â€” cannot deploy."
            exit 1
        }

        Write-Host "Creating deploy directory..."
        New-Item -ItemType Directory -Force -Path "C:\deployed-app" | Out-Null

        Write-Host "Copying files..."
        Copy-Item -Path "release\*" -Destination "C:\deployed-app" -Recurse -Force

        Write-Host "Deployment completed successfully!"